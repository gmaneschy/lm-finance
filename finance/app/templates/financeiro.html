{% extends "base.html" %}
{% load static %}


{% block title %}Dashboard Financeiro{% endblock %}

{% block content %}

<div class="container py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üìä Painel Financeiro</h3>
        <div class="btn-group">
            <a href="?mes={{ meses_nav.anterior.month }}&ano={{ meses_nav.anterior.year }}" class="btn btn-outline-secondary">‚óÄ Anterior</a>
            <button class="btn btn-secondary disabled">{{ data_atual|date:"F Y"|upper }}</button>
            <a href="?mes={{ meses_nav.proximo.month }}&ano={{ meses_nav.proximo.year }}" class="btn btn-outline-secondary">Pr√≥ximo ‚ñ∂</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-primary p-3">
                <h6>Faturamento Bruto</h6>
                <h3>R$ {{ kpis.faturamento|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-danger text-white p-3">
                <h6>Custos Totais</h6>
                <h3>R$ {{ kpis.custo_total|floatformat:2 }}</h3>
                <small style="font-size: 0.8em">CMV + Vari√°veis + Fixos</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-success p-3">
                <h6>Lucro L√≠quido</h6>
                <h3>R$ {{ kpis.lucro_liquido|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-info p-3">
                <h6>Margem de Lucro</h6>
                <h3>{{ kpis.margem }}%</h3>
                <small>Ticket M√©dio: R$ {{ kpis.ticket_medio|floatformat:2 }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 font-weight-bold text-primary">‚úèÔ∏è Despesas do M√™s</h5>
                    <small class="text-muted">Preencha os gastos operacionais deste m√™s.</small>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <h6 class="text-secondary mt-2"><small>Custos Vari√°veis (Insumos)</small></h6>
                        <div class="row g-2">
                            <div class="col-6 mb-2">{{ form.energia.label_tag }} {{ form.energia }}</div>
                            <div class="col-6 mb-2">{{ form.cola.label_tag }} {{ form.cola }}</div>
                            <div class="col-6 mb-2">{{ form.isqueiro.label_tag }} {{ form.isqueiro }}</div>
                            <div class="col-6 mb-2">{{ form.papeleta.label_tag }} {{ form.papeleta }}</div>
                            <div class="col-6 mb-2">{{ form.embalagem.label_tag }} {{ form.embalagem }}</div>
                            <div class="col-6 mb-2">{{ form.etiqueta.label_tag }} {{ form.etiqueta }}</div>
                        </div>
                        <hr>
                        <h6 class="text-secondary"><small>Taxas e Impostos</small></h6>
                        <div class="mb-2">{{ form.das_mei.label_tag }} {{ form.das_mei }}</div>
                        <div class="mb-2">{{ form.taxas_bancarias.label_tag }} {{ form.taxas_bancarias }}</div>
                        <div class="mb-3 mt-3">
                            {{ form.outros_variaveis.label_tag }}
                            {{ form.outros_variaveis }}
                        </div>
                        <button type="submit" class="btn btn-primary w-100">üíæ Salvar Despesas</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="m-0 font-weight-bold text-primary">üìà Evolu√ß√£o Di√°ria de Vendas</h6>

                        <form method="get" class="d-flex align-items-center" id="form-filtros-vendas">
                            <input type="hidden" name="mes" value="{{ data_atual.month }}">
                            <input type="hidden" name="ano" value="{{ data_atual.year }}">

                            <select name="metodo" class="form-select form-select-sm me-2" onchange="this.form.submit()">
                                <option value="">Todos Pagamentos</option>
                                {% for key, value in metodos_pagamento %}
                                    <option value="{{ key }}" {% if filtro_metodo_ativo == key %}selected{% endif %}>
                                        {{ value }}
                                    </option>
                                {% endfor %}
                            </select>

                            <select name="categoria" class="form-select form-select-sm" onchange="this.form.submit()">
                                <option value="">Todas Categorias</option>
                                {% for key, value in categorias_produto %}
                                    <option value="{{ key }}" {% if filtro_categoria_ativo == key %}selected{% endif %}>
                                        {{ value }}
                                    </option>
                                {% endfor %}
                            </select>
                        </form>
                    </div>
                    </div>
                <div class="card-body">
                    <canvas id="chartVendas" height="100"></canvas>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white">
                            <h6 class="m-0 font-weight-bold text-primary">üí∞ Para onde vai o dinheiro? (Custos Totais)</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chartCustos" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 bg-white p-3">
                        <h5 class="text-muted mb-3">Indicadores Extras</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ROI (Retorno s/ Investimento)
                                <span class="badge bg-primary rounded-pill">{{ kpis.roi|floatformat:1 }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Custo da Mercadoria (CMV)
                                <span class="badge bg-secondary rounded-pill">R$ {{ kpis.custo_total|floatformat:2 }}</span>
                            </li>
                             <li class="list-group-item mt-3 alert alert-warning">
                                <small>üí° <strong>Dica:</strong> Se sua margem estiver abaixo de 20%, revise o pre√ßo dos la√ßos ou o gasto com fitas.</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <h5 class="mt-4 pt-3 text-primary">üíé An√°lise de Custo por La√ßo (Unidade)</h5>
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-body">
                    <form method="get" class="mb-3" id="form-produto-custo">
                        <input type="hidden" name="mes" value="{{ data_atual.month }}">
                        <input type="hidden" name="ano" value="{{ data_atual.year }}">
                        <label for="id_produto_filtro" class="form-label">Selecione o Produto:</label>
                        <select name="produto_id" id="id_produto_filtro" class="form-select">
                            <option value="">-- Selecione para Analisar --</option>
                            {% for produto in produtos %}
                                <option value="{{ produto.id }}" {% if custo_produto_selecionado.produto_id|slugify == produto.id|slugify %}selected{% endif %}>
                                    {{ produto.nome }} (Pre√ßo: R$ {{ produto.valor_venda|floatformat:2 }})
                                </option>
                            {% endfor %}
                        </select>
                    </form>

                    <div id="custo-produto-detalhe">
                        {% if custo_produto_selecionado %}
                        <hr>
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-secondary">Composi√ß√£o do Custo Unit√°rio ({{ custo_produto_selecionado.nome }})</h6>
                                <canvas id="chartProdutoCusto" height="200"></canvas>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-secondary">Detalhes e Rentabilidade</h6>
                                <ul class="list-group list-group-flush">
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        Valor de Venda (Pre√ßo)
                                        <span class="badge bg-success rounded-pill">R$ {{ custo_produto_selecionado.valor_venda|floatformat:2 }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        **CUSTO TOTAL (CMV + Fixo)**
                                        <span class="badge bg-danger rounded-pill">R$ {{ custo_produto_selecionado.custo_total|floatformat:2 }}</span>
                                    </li>
                                    <li class="list-group-item d-flex justify-content-between align-items-center bg-light">
                                        **LUCRO BRUTO UNIT√ÅRIO**
                                        <span class="badge bg-primary rounded-pill">R$ {{ custo_produto_selecionado.lucro_liquido|floatformat:2 }}</span>
                                    </li>
                                </ul>

                                <h6 class="mt-3 text-secondary">Mat√©rias-Primas Detalhadas:</h6>
                                <small class="d-block mb-1">Custo de cada material no produto:</small>
                                <ul class="list-group">
                                    {% for material in custo_produto_selecionado.materiais_detalhe %}
                                        <li class="list-group-item d-flex justify-content-between align-items-center py-1">
                                            {{ material.nome|truncatechars:30 }}
                                            <span class="badge bg-secondary rounded-pill">R$ {{ material.valor|floatformat:2 }}</span>
                                        </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% else %}
                            <p class="text-muted text-center py-3">Selecione um produto no menu acima para ver o detalhamento do custo de produ√ß√£o e o lucro unit√°rio.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
            </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    // Vari√°veis globais para gr√°ficos
    let chartProdutoCustoInstance = null;

    // Fun√ß√£o de cores aleat√≥rias (Melhorada para ter mais contraste)
    function gerarCoresAleatorias(quantidade) {
        // Paleta base (cores vibrantes e seguras)
        const paleta = [
            '#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b',
            '#858796', '#2a5d4a', '#b7447d', '#724a87', '#99a91f'
        ];
        let cores = [];
        for (let i = 0; i < quantidade; i++) {
            if (i < paleta.length) {
                cores.push(paleta[i]);
            } else {
                // Se a paleta acabar, gera cor aleat√≥ria
                const r = Math.floor(Math.random() * 150) + 100; // Tons mais claros
                const g = Math.floor(Math.random() * 150) + 100;
                const b = Math.floor(Math.random() * 150) + 100;
                cores.push(`rgb(${r}, ${g}, ${b})`);
            }
        }
        return cores;
    }

    // Fun√ß√£o principal de inicializa√ß√£o do Chart.js
    function inicializarCharts() {
        // 1. Gr√°fico de Linha (Vendas por Dia)
        const ctxVendas = document.getElementById('chartVendas').getContext('2d');
        if (ctxVendas) {
            new Chart(ctxVendas, {
                type: 'line',
                data: {
                    // JSON.parse √© necess√°rio para converter a string JSON do Django em objeto JS
                    labels: JSON.parse('{{ charts.dias|safe }}'),
                    datasets: [{
                        label: 'Vendas (R$)',
                        data: JSON.parse('{{ charts.vendas_dia|safe }}'),
                        borderColor: '#4e73df',
                        backgroundColor: 'rgba(78, 115, 223, 0.05)',
                        tension: 0.3,
                        fill: true
                    }]
                },
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        // 2. Gr√°fico de Rosca (Custos Totais)
        const ctxCustos = document.getElementById('chartCustos').getContext('2d');
        if (ctxCustos) {
            new Chart(ctxCustos, {
                type: 'doughnut',
                data: {
                    labels: JSON.parse('{{ charts.custos_labels|safe }}'),
                    datasets: [{
                        data: JSON.parse('{{ charts.custos_values|safe }}'),
                        backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                    }]
                },
                options: { cutout: '70%' }
            });
        }
    }

    // Fun√ß√£o para renderizar/atualizar o Gr√°fico de Custo por Produto
    function renderizarChartProduto(labels, values) {
        // Se a inst√¢ncia j√° existir, destr√≥i para evitar conflito
        if (chartProdutoCustoInstance) {
            chartProdutoCustoInstance.destroy();
        }

        const ctxProduto = document.getElementById('chartProdutoCusto');

        // 3. Inicializa/Atualiza Gr√°fico de Custo por Produto
        if (ctxProduto && values && values.length > 0) {
            const cores = gerarCoresAleatorias(values.length);

            chartProdutoCustoInstance = new Chart(ctxProduto.getContext('2d'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: cores,
                    }]
                },
                options: {
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    const value = context.parsed;
                                    label += 'R$ ' + value.toFixed(2).replace('.', ',');
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        } else {
             // Caso n√£o haja dados ou o elemento ainda n√£o exista
             // A mensagem "Selecione um produto..." ser√° mostrada pelo template se custo_produto_selecionado for null.
        }
    }

    // Inicializa√ß√£o ao carregar a p√°gina
    window.onload = function() {
        inicializarCharts();

        // Inicializa o gr√°fico de custo por produto com os dados que vieram do Django (se existirem)
        {% if custo_produto_selecionado %}
            const produtoLabels = JSON.parse('{{ custo_produto_selecionado.custos_unitarios_labels|safe }}');
            const produtoValues = JSON.parse('{{ custo_produto_selecionado.custos_unitarios_chart|safe }}');
            renderizarChartProduto(produtoLabels, produtoValues);
        {% endif %}
    };


    // --- L√≥gica de Recarregamento para An√°lise de Custo por La√ßo (Mantida a submiss√£o) ---
    // ATEN√á√ÉO: Se o AJAX n√£o estiver configurado na View, o recarregamento completo ocorre.
    document.getElementById('id_produto_filtro').addEventListener('change', function() {
        const produtoId = this.value;
        if (produtoId) {
            // Se n√£o usar AJAX, submete o formul√°rio GET
            this.form.submit();
        } else {
             // Se desmarcar, submete o formul√°rio para limpar a se√ß√£o
             this.form.submit();
        }
    });

</script>

{% block scripts %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        .card-kpi { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s;}
        .card-kpi:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); color: white; }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); color: white; }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); color: white; }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); color: white; }
        .bg-gradient-danger { background: linear-gradient(45deg, #e74a3b, #be2617); color: white; }
    </style>
    <link rel="stylesheet" href="{% static 'css/financeiro.css' %}">

{% endblock %}
{% endblock %}