{% extends "base.html" %}
{% load static %}


{% block title %}Dashboard Financeiro{% endblock %}

{% block content %}

<body class="bg-light">

<div class="container py-4">

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>üìä Painel Financeiro</h3>
        <div class="btn-group">
            <a href="?mes={{ meses_nav.anterior.month }}&ano={{ meses_nav.anterior.year }}" class="btn btn-outline-secondary">‚óÄ Anterior</a>
            <button class="btn btn-secondary disabled">{{ data_atual|date:"F Y"|upper }}</button>
            <a href="?mes={{ meses_nav.proximo.month }}&ano={{ meses_nav.proximo.year }}" class="btn btn-outline-secondary">Pr√≥ximo ‚ñ∂</a>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-primary p-3">
                <h6>Faturamento Bruto</h6>
                <h3>R$ {{ kpis.faturamento|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-danger text-white p-3" style="background: linear-gradient(45deg, #e74a3b, #be2617);">
                <h6>Custos Totais</h6>
                <h3>R$ {{ kpis.custo_total|floatformat:2 }}</h3>
                <small style="font-size: 0.8em">CMV + Vari√°veis + Fixos</small>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-success p-3">
                <h6>Lucro L√≠quido</h6>
                <h3>R$ {{ kpis.lucro_liquido|floatformat:2 }}</h3>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card card-kpi bg-gradient-info p-3">
                <h6>Margem de Lucro</h6>
                <h3>{{ kpis.margem }}%</h3>
                <small>Ticket M√©dio: R$ {{ kpis.ticket_medio|floatformat:2 }}</small>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-white py-3">
                    <h5 class="m-0 font-weight-bold text-primary">‚úèÔ∏è Despesas do M√™s</h5>
                    <small class="text-muted">Preencha os gastos operacionais deste m√™s.</small>
                </div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}

                        <h6 class="text-secondary mt-2"><small>Custos Vari√°veis (Insumos)</small></h6>
                        <div class="row g-2">
                            <div class="col-6 mb-2">{{ form.energia.label_tag }} {{ form.energia }}</div>
                            <div class="col-6 mb-2">{{ form.cola.label_tag }} {{ form.cola }}</div>
                            <div class="col-6 mb-2">{{ form.isqueiro.label_tag }} {{ form.isqueiro }}</div>
                            <div class="col-6 mb-2">{{ form.papeleta.label_tag }} {{ form.papeleta }}</div>
                            <div class="col-6 mb-2">{{ form.embalagem.label_tag }} {{ form.embalagem }}</div>
                            <div class="col-6 mb-2">{{ form.etiqueta.label_tag }} {{ form.etiqueta }}</div>
                        </div>

                        <hr>
                        <h6 class="text-secondary"><small>Taxas e Impostos</small></h6>
                        <div class="mb-2">{{ form.das_mei.label_tag }} {{ form.das_mei }}</div>
                        <div class="mb-2">{{ form.taxas_bancarias.label_tag }} {{ form.taxas_bancarias }}</div>

                        <div class="mb-3 mt-3">
                            {{ form.outros_variaveis.label_tag }}
                            {{ form.outros_variaveis }}
                        </div>

                        <button type="submit" class="btn btn-primary w-100">üíæ Salvar Despesas</button>
                    </form>
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            <div class="card shadow-sm border-0 mb-4">
                <div class="card-header bg-white">
                    <h6 class="m-0 font-weight-bold text-primary">üìà Evolu√ß√£o Di√°ria de Vendas</h6>
                </div>
                <div class="card-body">
                    <canvas id="chartVendas" height="100"></canvas>
                </div>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0">
                        <div class="card-header bg-white">
                            <h6 class="m-0 font-weight-bold text-primary">üí∞ Para onde vai o dinheiro?</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chartCustos" height="200"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 h-100 bg-white p-3">
                        <h5 class="text-muted mb-3">Indicadores Extras</h5>
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                ROI (Retorno s/ Investimento)
                                <span class="badge bg-primary rounded-pill">{{ kpis.roi|floatformat:1 }}%</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                Custo da Mercadoria (CMV)
                                <span class="badge bg-secondary rounded-pill">R$ {{ kpis.custo_total|floatformat:2 }}</span>
                            </li>
                             <li class="list-group-item mt-3 alert alert-warning">
                                <small>üí° <strong>Dica:</strong> Se sua margem estiver abaixo de 20%, revise o pre√ßo dos la√ßos ou o gasto com fitas.</small>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>

<script>
    // Gr√°fico de Linha (Vendas por Dia)
    const ctxVendas = document.getElementById('chartVendas').getContext('2d');
    if (ctxVendas) { // Verifica se o canvas existe
        new Chart(ctxVendas, {
            type: 'line',
            data: {
                labels: {{ charts.dias|safe }},
                datasets: [{
                    label: 'Vendas (R$)',
                    data: {{ charts.vendas_dia|safe }},
                    borderColor: '#4e73df',
                    backgroundColor: 'rgba(78, 115, 223, 0.05)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: { scales: { y: { beginAtZero: true } } }
        });
    }


    // Gr√°fico de Rosca (Custos)
    const ctxCustos = document.getElementById('chartCustos').getContext('2d');
    if (ctxCustos) { // Verifica se o canvas existe
        new Chart(ctxCustos, {
            type: 'doughnut',
            data: {
                labels: {{ charts.custos_labels|safe }},
                datasets: [{
                    data: {{ charts.custos_values|safe }},
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc'],
                }]
            },
            options: { cutout: '70%' }
        });
    }
</script>


{% block scripts %}
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .card-kpi { border: none; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: transform 0.2s;}
        .card-kpi:hover { transform: translateY(-5px); }
        .bg-gradient-primary { background: linear-gradient(45deg, #4e73df, #224abe); color: white; }
        .bg-gradient-success { background: linear-gradient(45deg, #1cc88a, #13855c); color: white; }
        .bg-gradient-info { background: linear-gradient(45deg, #36b9cc, #258391); color: white; }
        .bg-gradient-warning { background: linear-gradient(45deg, #f6c23e, #dda20a); color: white; }
    </style>


<link rel="stylesheet" href="{% static 'css/financeiro.css' %}">
<script src="{% static 'js/financeiro.js' %}"></script>

{% endblock %}
{% endblock %}